<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Care Plan Generator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5; color: #333; line-height: 1.5;
    }
    .container { max-width: 860px; margin: 0 auto; padding: 24px 16px; }

    h1 { color: #c00; margin-bottom: 4px; }
    .subtitle { color: #888; margin-bottom: 28px; font-size: 14px; }

    .card {
      background: #fff; border-radius: 10px; padding: 24px;
      margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,.1);
    }
    .card h2 { font-size: 18px; margin-bottom: 16px; }

    /* ── Form ── */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 4px; }
    input {
      width: 100%; padding: 9px 12px; border: 1px solid #ddd;
      border-radius: 6px; font-size: 14px;
    }
    input:focus { outline: none; border-color: #c00; }

    button#submit-btn {
      margin-top: 18px; background: #c00; color: #fff; border: none;
      padding: 11px 36px; border-radius: 6px; font-size: 15px;
      cursor: pointer; transition: background .2s;
    }
    button#submit-btn:hover { background: #a00; }
    button#submit-btn:disabled { background: #bbb; cursor: not-allowed; }

    /* ── Status badges ── */
    .badge {
      display: inline-block; padding: 3px 10px; border-radius: 10px;
      font-size: 12px; font-weight: 600; text-transform: uppercase;
    }
    .badge-pending    { background: #fff3cd; color: #856404; }
    .badge-processing { background: #cce5ff; color: #004085; }
    .badge-completed  { background: #d4edda; color: #155724; }
    .badge-failed     { background: #f8d7da; color: #721c24; }

    /* ── Result area ── */
    #result { display: none; }
    .plan-text { margin-top: 14px; line-height: 1.7; }
    .plan-text h3 { margin: 18px 0 6px; color: #222; }
    .plan-text ul, .plan-text ol { margin-left: 20px; }
    .plan-text li { margin-bottom: 2px; }

    /* ── History ── */
    .history-item {
      border-bottom: 1px solid #eee; padding: 14px 0;
    }
    .history-item:last-child { border-bottom: none; }
    .history-header { display: flex; justify-content: space-between; align-items: center; }
    .history-meta { font-size: 13px; color: #888; margin-top: 2px; }
    .history-plan { margin-top: 10px; font-size: 14px; }
    .empty-msg { color: #aaa; }

    /* ── Search ── */
    .search-bar {
      display: flex; gap: 10px; margin-bottom: 16px;
    }
    .search-bar input {
      flex: 1; padding: 9px 12px; border: 1px solid #ddd;
      border-radius: 6px; font-size: 14px;
    }
    .search-bar input:focus { outline: none; border-color: #c00; }
    .search-bar button {
      background: #c00; color: #fff; border: none; padding: 9px 20px;
      border-radius: 6px; font-size: 14px; cursor: pointer;
    }
    .search-bar button:hover { background: #a00; }

    /* ── Download button ── */
    .btn-download {
      display: inline-block; margin-top: 8px; padding: 5px 14px;
      background: #0066cc; color: #fff; border: none; border-radius: 4px;
      font-size: 12px; cursor: pointer; text-decoration: none;
    }
    .btn-download:hover { background: #004999; }

    /* ── Spinner ── */
    .spinner {
      display: inline-block; width: 18px; height: 18px;
      border: 3px solid #ddd; border-top-color: #c00;
      border-radius: 50%; animation: spin .8s linear infinite;
      vertical-align: middle; margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div class="container">

  <h1>AI Care Plan Generator</h1>
  <p class="subtitle">Generate clinical pharmacy care plans powered by AI</p>

  <!-- ── Form ── -->
  <div class="card">
    <h2>New Care Plan Request</h2>
    <form id="careplan-form">
      <div class="form-grid">
        <div><label>Patient Name</label><input id="patient_name" placeholder="Jane Doe" required></div>
        <div><label>MRN</label><input id="patient_mrn" placeholder="123456" required></div>
        <div><label>Medication</label><input id="medication" placeholder="Metformin 500mg" required></div>
        <div><label>ICD-10 Code</label><input id="icd10_code" placeholder="E11.9" required></div>
        <div><label>Provider Name</label><input id="provider_name" placeholder="Smith" required></div>
        <div><label>Provider NPI</label><input id="provider_npi" placeholder="1234567890" required></div>
      </div>
      <button type="submit" id="submit-btn">Generate Care Plan</button>
    </form>
  </div>

  <!-- ── Result ── -->
  <div class="card" id="result">
    <div class="history-header">
      <h2>Generated Care Plan</h2>
      <span class="badge" id="result-status"></span>
    </div>
    <div class="plan-text" id="result-content"></div>
  </div>

  <!-- ── History ── -->
  <div class="card">
    <h2>Care Plan History</h2>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search by patient, medication, ICD-10, provider…">
      <button onclick="loadHistory()">Search</button>
    </div>
    <div id="history"><p class="empty-msg">Loading…</p></div>
  </div>

</div>

<script>
  /* ── helpers ── */
  function mdToHtml(text) {
    let html = text
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')          // escape
      .replace(/^## (.+)$/gm,   '<h3>$1</h3>')               // ## → h3
      .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>')            // 1. → li
      .replace(/^- (.+)$/gm,       '<li>$1</li>')             // -  → li
      .replace(/\n{2,}/g, '<br>');                             // blank lines
    return html;
  }

  function badgeHtml(status) {
    return `<span class="badge badge-${status}">${status}</span>`;
  }

  /* ── Load history ── */
  async function loadHistory() {
    try {
      const q = document.getElementById('search-input').value.trim();
      const url = q ? `/api/careplans/?q=${encodeURIComponent(q)}` : '/api/careplans/';
      const res  = await fetch(url);
      const plans = await res.json();
      const el = document.getElementById('history');
      if (!plans.length) { el.innerHTML = '<p class="empty-msg">No care plans found.</p>'; return; }
      el.innerHTML = plans.map(p => `
        <div class="history-item">
          <div class="history-header">
            <strong>${p.patient_name}</strong>
            ${badgeHtml(p.status)}
          </div>
          <div class="history-meta">${p.medication} · ${new Date(p.created_at).toLocaleString()}</div>
          ${p.status === 'completed' ? `
            <div class="history-plan">${mdToHtml(p.care_plan_text)}</div>
            <a class="btn-download" href="/api/careplans/${p.id}/download/">Download .txt</a>
          ` : ''}
        </div>`).join('');
    } catch(e) { console.error(e); }
  }

  /* ── Enter 键触发搜索 ── */
  document.getElementById('search-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') loadHistory();
  });

  loadHistory();

  /* ── Form submit ── */
  document.getElementById('careplan-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Generating…';

    const resultDiv = document.getElementById('result');
    resultDiv.style.display = 'block';
    document.getElementById('result-status').className = 'badge badge-processing';
    document.getElementById('result-status').textContent = 'processing';
    document.getElementById('result-content').innerHTML = 'Calling LLM, please wait…';

    const body = {
      patient_name:  document.getElementById('patient_name').value,
      patient_mrn:   document.getElementById('patient_mrn').value,
      medication:    document.getElementById('medication').value,
      icd10_code:    document.getElementById('icd10_code').value,
      provider_name: document.getElementById('provider_name').value,
      provider_npi:  document.getElementById('provider_npi').value,
    };

    try {
      const res  = await fetch('/api/generate/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json();

      document.getElementById('result-status').className = `badge badge-${data.status}`;
      document.getElementById('result-status').textContent = data.status;

      if (data.status === 'completed') {
        document.getElementById('result-content').innerHTML =
          mdToHtml(data.care_plan_text) +
          `<a class="btn-download" href="/api/careplans/${data.id}/download/">Download .txt</a>`;
      } else {
        document.getElementById('result-content').innerHTML =
          `<p style="color:#c00">Generation failed. ${data.care_plan_text}</p>`;
      }
      loadHistory();
    } catch (err) {
      document.getElementById('result-status').className = 'badge badge-failed';
      document.getElementById('result-status').textContent = 'failed';
      document.getElementById('result-content').innerHTML =
        `<p style="color:#c00">Request error: ${err.message}</p>`;
    }

    btn.disabled = false;
    btn.textContent = 'Generate Care Plan';
  });
</script>
</body>
</html>
