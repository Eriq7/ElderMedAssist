<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ElderMedAssist</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5; color: #333; line-height: 1.5;
    }
    .container { max-width: 860px; margin: 0 auto; padding: 24px 16px; }

    h1 { color: #2563eb; margin-bottom: 4px; }
    .subtitle { color: #888; margin-bottom: 28px; font-size: 14px; }

    .card {
      background: #fff; border-radius: 10px; padding: 24px;
      margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,.1);
    }
    .card h2 { font-size: 18px; margin-bottom: 16px; }

    /* ── Form ── */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-full { grid-column: 1 / -1; }
    label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 4px; }
    input, textarea {
      width: 100%; padding: 9px 12px; border: 1px solid #ddd;
      border-radius: 6px; font-size: 14px; font-family: inherit;
    }
    textarea { resize: vertical; min-height: 60px; }
    input:focus, textarea:focus { outline: none; border-color: #2563eb; }

    button#submit-btn {
      margin-top: 18px; background: #2563eb; color: #fff; border: none;
      padding: 11px 36px; border-radius: 6px; font-size: 15px;
      cursor: pointer; transition: background .2s;
    }
    button#submit-btn:hover { background: #1d4ed8; }
    button#submit-btn:disabled { background: #bbb; cursor: not-allowed; }

    /* ── Status badges ── */
    .badge {
      display: inline-block; padding: 3px 10px; border-radius: 10px;
      font-size: 12px; font-weight: 600; text-transform: uppercase;
    }
    .badge-pending    { background: #fff3cd; color: #856404; }
    .badge-processing { background: #cce5ff; color: #004085; }
    .badge-completed  { background: #d4edda; color: #155724; }
    .badge-failed     { background: #f8d7da; color: #721c24; }

    /* ── Result area ── */
    #result { display: none; }
    .plan-text { margin-top: 14px; line-height: 1.7; }
    .plan-text h3 { margin: 18px 0 6px; color: #222; }
    .plan-text ul, .plan-text ol { margin-left: 20px; }
    .plan-text li { margin-bottom: 2px; }

    /* ── History ── */
    .history-item {
      border-bottom: 1px solid #eee; padding: 14px 0;
    }
    .history-item:last-child { border-bottom: none; }
    .history-header { display: flex; justify-content: space-between; align-items: center; }
    .history-meta { font-size: 13px; color: #888; margin-top: 2px; }
    .history-plan { margin-top: 10px; font-size: 14px; }
    .empty-msg { color: #aaa; }

    /* ── Search ── */
    .search-bar {
      display: flex; gap: 10px; margin-bottom: 16px;
    }
    .search-bar input {
      flex: 1; padding: 9px 12px; border: 1px solid #ddd;
      border-radius: 6px; font-size: 14px;
    }
    .search-bar input:focus { outline: none; border-color: #2563eb; }
    .search-bar button {
      background: #2563eb; color: #fff; border: none; padding: 9px 20px;
      border-radius: 6px; font-size: 14px; cursor: pointer;
    }
    .search-bar button:hover { background: #1d4ed8; }

    /* ── Download button ── */
    .btn-download {
      display: inline-block; margin-top: 8px; padding: 5px 14px;
      background: #0066cc; color: #fff; border: none; border-radius: 4px;
      font-size: 12px; cursor: pointer; text-decoration: none;
    }
    .btn-download:hover { background: #004999; }

    /* ── Spinner ── */
    .spinner {
      display: inline-block; width: 18px; height: 18px;
      border: 3px solid #ddd; border-top-color: #2563eb;
      border-radius: 50%; animation: spin .8s linear infinite;
      vertical-align: middle; margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div class="container">

  <h1>ElderMedAssist</h1>
  <p class="subtitle">Your AI-powered daily medication guide for safer, simpler care</p>

  <!-- ── Form ── -->
  <div class="card">
    <h2>Your Information</h2>
    <form id="careplan-form">
      <div class="form-grid">
        <div><label>First Name</label><input id="patient_first_name" placeholder="Jane" required></div>
        <div><label>Last Name</label><input id="patient_last_name" placeholder="Doe" required></div>
        <div><label>Date of Birth</label><input id="date_of_birth" type="date" required></div>
        <div></div>
        <div class="form-full">
          <label>Medications</label>
          <textarea id="medications" placeholder="e.g. Metformin 500mg, Lisinopril 10mg, Aspirin 81mg" required></textarea>
        </div>
        <div class="form-full">
          <label>Allergies (optional)</label>
          <textarea id="allergies" placeholder="e.g. Penicillin, Sulfa drugs"></textarea>
        </div>
        <div class="form-full">
          <label>Health Conditions (optional)</label>
          <textarea id="health_conditions" placeholder="e.g. Type 2 Diabetes, High Blood Pressure"></textarea>
        </div>
      </div>
      <button type="submit" id="submit-btn">Generate My Medication Guide</button>
    </form>
  </div>

  <!-- ── Result ── -->
  <div class="card" id="result">
    <div class="history-header">
      <h2>Your Medication Guide</h2>
      <span class="badge" id="result-status"></span>
    </div>
    <div class="plan-text" id="result-content"></div>
  </div>

  <!-- ── History ── -->
  <div class="card">
    <h2>Previous Guides</h2>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search by name or medication...">
      <button onclick="loadHistory()">Search</button>
    </div>
    <div id="history"><p class="empty-msg">Loading...</p></div>
  </div>

</div>

<script>
  /* ── helpers ── */
  function mdToHtml(text) {
    let html = text
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/^## (.+)$/gm,   '<h3>$1</h3>')
      .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>')
      .replace(/^- (.+)$/gm,       '<li>$1</li>')
      .replace(/\n{2,}/g, '<br>');
    return html;
  }

  function badgeHtml(status) {
    return `<span class="badge badge-${status}">${status}</span>`;
  }

  /* ── Load history ── */
  async function loadHistory() {
    try {
      const q = document.getElementById('search-input').value.trim();
      const url = q ? `/api/careplans/?q=${encodeURIComponent(q)}` : '/api/careplans/';
      const res  = await fetch(url);
      const plans = await res.json();
      const el = document.getElementById('history');
      if (!plans.length) { el.innerHTML = '<p class="empty-msg">No guides found.</p>'; return; }
      el.innerHTML = plans.map(p => `
        <div class="history-item">
          <div class="history-header">
            <strong>${p.patient_name}</strong>
            ${badgeHtml(p.status)}
          </div>
          <div class="history-meta">${p.medications} · ${new Date(p.created_at).toLocaleString()}</div>
          ${p.status === 'completed' ? `
            <div class="history-plan">${mdToHtml(p.care_plan_text)}</div>
            <a class="btn-download" href="/api/careplans/${p.id}/download/">Download .txt</a>
          ` : ''}
        </div>`).join('');
    } catch(e) { console.error(e); }
  }

  document.getElementById('search-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') loadHistory();
  });

  loadHistory();

  /* ── Polling ── */
  function pollStatus(carePlanId) {
    const INTERVAL = 3000;

    const timer = setInterval(async () => {
      try {
        const res = await fetch(`/api/careplans/${carePlanId}/status/`);
        const data = await res.json();

        document.getElementById('result-status').className = `badge badge-${data.status}`;
        document.getElementById('result-status').textContent = data.status;

        if (data.status === 'completed') {
          clearInterval(timer);
          document.getElementById('result-content').innerHTML =
            mdToHtml(data.care_plan_text) +
            `<a class="btn-download" href="/api/careplans/${carePlanId}/download/">Download .txt</a>`;
          loadHistory();
        } else if (data.status === 'failed') {
          clearInterval(timer);
          document.getElementById('result-content').innerHTML =
            `<p style="color:#c00">Generation failed. ${data.care_plan_text || ''}</p>`;
          loadHistory();
        }
      } catch (err) {
        console.error('Polling error:', err);
      }
    }, INTERVAL);
  }

  /* ── Form submit ── */
  document.getElementById('careplan-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Generating...';

    const resultDiv = document.getElementById('result');
    resultDiv.style.display = 'block';
    document.getElementById('result-status').className = 'badge badge-pending';
    document.getElementById('result-status').textContent = 'pending';
    document.getElementById('result-content').innerHTML = '<p><span class="spinner"></span>Generating your medication guide, please wait...</p>';

    const body = {
      patient_first_name: document.getElementById('patient_first_name').value,
      patient_last_name:  document.getElementById('patient_last_name').value,
      date_of_birth:      document.getElementById('date_of_birth').value,
      medications:        document.getElementById('medications').value,
      allergies:          document.getElementById('allergies').value,
      health_conditions:  document.getElementById('health_conditions').value,
    };

    try {
      const res  = await fetch('/api/generate/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json();

      if (data.id) {
        pollStatus(data.id);
      } else {
        document.getElementById('result-status').className = 'badge badge-failed';
        document.getElementById('result-status').textContent = 'error';
        document.getElementById('result-content').innerHTML =
          `<p style="color:#c00">${data.message || 'Something went wrong.'}</p>`;
      }

    } catch (err) {
      document.getElementById('result-status').className = 'badge badge-failed';
      document.getElementById('result-status').textContent = 'failed';
      document.getElementById('result-content').innerHTML =
        `<p style="color:#c00">Request error: ${err.message}</p>`;
    }

    btn.disabled = false;
    btn.textContent = 'Generate My Medication Guide';
  });
</script>
</body>
</html>
